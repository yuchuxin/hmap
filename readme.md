# HMap æ–‡æ¡£

> `hmap` æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å®ç°çš„çº¿ç¨‹å®‰å…¨ã€é«˜å¹¶å‘ Mapã€‚é€šè¿‡å°†æ•°æ®åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªåˆ†ç‰‡ï¼ˆShardsï¼‰ä¸­ï¼Œæœ‰æ•ˆå‡å°‘äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ç«äº‰ï¼Œæå‡è¯»å†™æ€§èƒ½ã€‚

---

## ğŸ“– ç®€ä»‹

`hmap` æ˜¯ä¸€ä¸ª Go è¯­è¨€å®ç°çš„æ³›å‹å¹¶å‘å®‰å…¨ Mapï¼Œé‡‡ç”¨åˆ†ç‰‡é”ï¼ˆShardingï¼‰æŠ€æœ¯é™ä½é”ç«äº‰ï¼Œé€‚ç”¨äºé«˜å¹¶å‘è¯»å†™åœºæ™¯ã€‚

**ç‰¹æ€§ï¼š**
*   **âœ…çº¿ç¨‹å®‰å…¨**ï¼šæ”¯æŒå¤š Goroutine å¹¶å‘è¯»å†™ã€‚
*   **âœ…é«˜æ€§èƒ½**ï¼šé‡‡ç”¨åˆ†ç‰‡é”ï¼ˆShardingï¼‰æœºåˆ¶ï¼Œæ˜¾è‘—é™ä½é”ç²’åº¦ã€‚
*   **âœ…æ³›å‹æ”¯æŒ**ï¼šæ”¯æŒå­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆ`[V any]`ï¼‰ï¼ŒKey å›ºå®šä¸º `string`ã€‚
*   **âœ…é›¶æ‹·è´å“ˆå¸Œ**ï¼šä½¿ç”¨ `sync.Pool` å¤ç”¨ Hash å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ›ã€‚
*   **âœ…æ­»é”é¢„é˜²**ï¼š`Range` æ“ä½œé‡‡ç”¨å¿«ç…§æœºåˆ¶ï¼Œæ”¯æŒåœ¨éå†å›è°ƒä¸­å®‰å…¨åœ°æ“ä½œ Mapã€‚
*   **âœ…ä½è¿ç®—ä¼˜åŒ–**ï¼šè‡ªåŠ¨è°ƒæ•´åˆ†ç‰‡æ•°é‡ä¸º 2 çš„å¹‚æ¬¡ï¼Œåˆ©ç”¨ä½è¿ç®—åŠ é€Ÿå®šä½ã€‚

---

## âš ï¸ ç¯å¢ƒè¦æ±‚

*   **Go 1.21+** (ä¾èµ–æ ‡å‡†åº“ `maps` åŒ…)

---

## ğŸ“¦ å®‰è£…

```bash
go get your-module-path/hmap
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```go
package main

import "your-module-path/hmap"

func main() {
    // åˆ›å»º Mapï¼ˆé»˜è®¤ 32 åˆ†ç‰‡ï¼‰
    m := hmap.New[string]()

    // åŸºæœ¬æ“ä½œ
    m.Set("name", "Alice")
    value, ok := m.Get("name")
    m.Del("name")
}
```

---

## ğŸ“š API æ–‡æ¡£

### åˆ›å»º

```go
func New[V any](shardCount ...int) *Map[V]
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `shardCount` | `int` (å¯é€‰) | åˆ†ç‰‡æ•°é‡ï¼Œè‡ªåŠ¨å‘ä¸Šå–æ•´ä¸º 2 çš„å¹‚ï¼Œé»˜è®¤ 32 |

**ç¤ºä¾‹ï¼š**
```go
m1 := hmap.New[int]()          // é»˜è®¤ 32 åˆ†ç‰‡
m2 := hmap.New[string](64)     // 64 åˆ†ç‰‡
m3 := hmap.New[*User](128)     // 128 åˆ†ç‰‡ï¼Œå­˜å‚¨æŒ‡é’ˆç±»å‹
```

---

### åŸºæœ¬æ“ä½œ

#### Set - è®¾ç½®é”®å€¼å¯¹

```go
func (m *Map[V]) Set(key string, value V, onlyIfNotExist ...bool) V
```

| è¿”å›å€¼ | è¯´æ˜ |
|-------|------|
| `onlyIfNotExist` | ä¸ºtrueæ—¶ï¼Œä»…å½“keyä¸å­˜åœ¨æ—¶æ‰ä¼šåˆ›å»ºï¼Œé»˜è®¤false |

| è¿”å›å€¼ | è¯´æ˜ |
|-------|------|
| `V` | è®¾ç½®çš„å€¼æˆ–å·²ç»å­˜åœ¨çš„å€¼ |

```go
m.Set("user:1001", User{Name: "Alice"})
```

---

#### Get - è·å–å€¼

```go
func (m *Map[V]) Get(key string, defaultValue ...V) (V, bool)
```

| è¿”å›å€¼ | è¯´æ˜ |
|-------|------|
| `V` | é”®å¯¹åº”çš„å€¼ï¼Œä¸å­˜åœ¨æ—¶è¿”å›é›¶å€¼æˆ–é»˜è®¤å€¼ |
| `bool` | é”®æ˜¯å¦å­˜åœ¨ |

```go
// åŸºæœ¬ç”¨æ³•
value, ok := m.Get("user:1001")

// å¸¦é»˜è®¤å€¼
value, ok := m.Get("user:1001", User{Name: "Unknown"})
```

---

#### Delete - åˆ é™¤é”®

```go
func (m *Map[V]) Delete(key string) bool
```

| è¿”å›å€¼ | è¯´æ˜ |
|-------|------|
| `bool` | é”®æ˜¯å¦å­˜åœ¨ |

```go
m.Del("user:1001")
```

---

### éå†ä¸æŸ¥è¯¢

#### Len - è·å–å…ƒç´ æ•°é‡

```go
func (m *Map[V]) Len() int
```

> âš ï¸ **æ³¨æ„**ï¼šå¹¶å‘ç¯å¢ƒä¸‹è¿”å›çš„æ˜¯è¿‘ä¼¼å€¼

---

#### Range - éå†æ‰€æœ‰å…ƒç´ 

```go
func (m *Map[V]) Range(f func(key string, value V) bool)
```

è¿”å› `false` å¯æå‰ç»ˆæ­¢éå†ã€‚

```go
m.Range(func(key string, value int) bool {
    fmt.Printf("%s: %d\n", key, value)
    return true  // ç»§ç»­éå†
})
```

> âš ï¸ **æ³¨æ„**ï¼šç”±äºæ¶‰åŠå†…å­˜æ‹·è´ï¼Œåœ¨å¤§æ•°æ®é‡åœºæ™¯ä¸‹è¯·è°¨æ…ä½¿ç”¨ã€‚

---

#### GetAllMaps - è·å–æ‰€æœ‰æ•°æ®çš„å‰¯æœ¬

```go
func (m *Map[V]) GetAllMaps() map[string]V
```

> âš ï¸ **æ³¨æ„**ï¼šè¿”å›çš„æ˜¯æµ…æ‹·è´ï¼›å¹¶å‘ç¯å¢ƒä¸‹å¯èƒ½éå®Œå…¨ä¸€è‡´çš„å¿«ç…§
>
> âš ï¸ **æ€§èƒ½è­¦å‘Š**: ä¼šè¿›è¡Œå…¨é‡æ•°æ®æ‹·è´ã€‚

---

#### GetMaps - è·å–æŒ‡å®šåˆ†ç‰‡æ•°æ®

```go
func (m *Map[V]) GetMaps(index int) map[string]V
```

```go
shard0Data := m.GetMaps(0)  // è·å–ç¬¬ 0 ä¸ªåˆ†ç‰‡çš„å‰¯æœ¬
```

---

### å…¶ä»–æ“ä½œ

#### Clear - æ¸…ç©ºæ‰€æœ‰æ•°æ®

```go
func (m *Map[V]) Clear()
```

---

#### ShardCount - è·å–åˆ†ç‰‡æ•°é‡

```go
func (m *Map[V]) ShardCount() int
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```go
package main

import (
    "fmt"
    "hmap"
)

func main() {
    // åˆ›å»ºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„ Map
    users := hmap.New[User]()

    // æ·»åŠ ç”¨æˆ·
    users.Set("u1", User{Name: "Alice", Age: 25})
    users.Set("u2", User{Name: "Bob", Age: 30})

    // è·å–ç”¨æˆ·
    if user, ok := users.Get("u1"); ok {
        fmt.Printf("Found: %s\n", user.Name)
    }

    // éå†
    users.Range(func(key string, user User) bool {
        fmt.Printf("%s -> %s\n", key, user.Name)
        return true
    })

    // ç»Ÿè®¡
    fmt.Printf("Total users: %d\n", users.Len())
}

type User struct {
    Name string
    Age  int
}
```

### å¹¶å‘åœºæ™¯

```go
func main() {
    m := hmap.New[int](64)  // é«˜å¹¶å‘å»ºè®®å¢åŠ åˆ†ç‰‡æ•°

    var wg sync.WaitGroup

    // å¹¶å‘å†™å…¥
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func(n int) {
            defer wg.Done()
            m.Set(fmt.Sprintf("key:%d", n), n)
        }(i)
    }

    // å¹¶å‘è¯»å–
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func(n int) {
            defer wg.Done()
            m.Get(fmt.Sprintf("key:%d", n))
        }(i)
    }

    wg.Wait()
    fmt.Printf("Final count: %d\n", m.Len())
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

| äº‹é¡¹ | è¯´æ˜ |
|-----|------|
| **Key ç±»å‹** | ç›®å‰ä»…æ”¯æŒ string ç±»å‹ã€‚å¦‚æœéœ€è¦å…¶ä»–ç±»å‹çš„ Keyï¼Œå»ºè®®åœ¨å¤–éƒ¨è½¬ä¸º string æˆ–ä¿®æ”¹æºç ä¸­çš„ hash è®¡ç®—éƒ¨åˆ† |
| **æµ…æ‹·è´** | `GetMaps`/`GetAllMaps` è¿”å›æµ…æ‹·è´ï¼Œå¼•ç”¨ç±»å‹éœ€æ³¨æ„ï¼Œä¿®æ”¹è¿”å›çš„å¼•ç”¨ç±»å‹ä¼šå¯¼è‡´åŸæ•°æ®ä¿®æ”¹ |
| **éåŸå­å¿«ç…§** | `Len`/`GetAllMaps` åœ¨å¹¶å‘ä¸‹å¯èƒ½ä¸ç²¾ç¡® |
| **éå†é¡ºåº** | `Range` éå†é¡ºåºä¸ç¡®å®š |
| **åˆ†ç‰‡æ•°é‡** | é«˜å¹¶å‘åœºæ™¯å»ºè®®é€‚å½“å¢åŠ åˆ†ç‰‡æ•°ï¼ˆå¦‚ 64ã€128ï¼‰ |
| **æ€§èƒ½** | Range æ–¹æ³•ä¸ºäº†ä¿è¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼ˆé¿å…æ­»é”ï¼‰ï¼Œé‡‡ç”¨äº†â€œè¯»æ—¶å¤åˆ¶â€ç­–ç•¥ã€‚å¦‚æœå­˜å‚¨äº†æ•°ç™¾ä¸‡ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨ Range ä¼šå¯¼è‡´å¤§é‡çš„å†…å­˜åˆ†é…ã€‚<br>åœ¨æ ¸å¿ƒçƒ­ç‚¹è·¯å¾„ä¸Šï¼Œåº”å°½é‡é¿å…é¢‘ç¹è°ƒç”¨ Range æˆ– GetAllMapsã€‚ |

---

## ğŸ¯ æ€§èƒ½å»ºè®®

```
åˆ†ç‰‡æ•°é‡é€‰æ‹©å‚è€ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¹¶å‘ Goroutine â”‚ å»ºè®®åˆ†ç‰‡æ•°     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ < 100        â”‚ 32ï¼ˆé»˜è®¤ï¼‰     â”‚
â”‚ 100 - 1000   â”‚ 64            â”‚
â”‚ > 1000       â”‚ 128 - 256     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“„ License

MIT License